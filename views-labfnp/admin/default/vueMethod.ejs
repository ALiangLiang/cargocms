var defaultVueMathod = {
  cancel: function (event) {
    appMain.onLeavePageEdit(function() {
      location.href = '/admin/#/admin/'+modelName;
    });
  },
  save: function (event) {
    $.ajax({
      url: '/api/admin/'+modelName,
      type: 'POST',
      dataType: 'json',
      data: appModel.data.item,
      xhrFields: {
        withCredentials: true,
      },
      success: ajaxSuccess,
      error: ajaxError,
    });

    function ajaxSuccess(result) {
      location.href = '/admin/#/admin/'+modelName;
      messageApp.show({desc: '新增成功！', type: 'success'});
    } // end ajaxSuccess

    function ajaxError(result) {
      messageApp.show({desc: '新增資料失敗！errorMessage: ' + result.responseJSON.message, type: 'error'});
    }
  },
  update: function (event) {
    $.ajax({
      url: '/api/admin/' + modelName + '/' + appModel.data.item.id,
      type: 'PUT',
      dataType: 'json',
      data: appModel.data.item,
      xhrFields: {
        withCredentials: true,
      },
      success: ajaxSuccess,
      error: ajaxError,
    });

    function ajaxSuccess(result) {
      location.href = '/admin/#/admin/' + modelName;
      messageApp.show({desc: '更新會員資料成功！', type: 'success'});
    } // end ajaxSuccess

    function ajaxError(result) {
      console.log(result);
      messageApp.show({desc: '更新資料失敗！errorMessage: ' + result.responseJSON.message, type: 'error'});
    }
  },
  loadItem: function (cb) {

    window.onbeforeunload = null;
    $.get('/api/admin/'+modelName+'/' + appModel.data.item.id, ajaxSuccess);

    function ajaxSuccess(result) {
      if (result.success) {
        appModel.data.item = result.data;
        appModel.data.option.passwordConfirm = result.data.Passports[0].password;
        var hasAvatar = typeof result.data.avatar === 'string';
        if (!hasAvatar) {
          appModel.data.item.avatar = COMMON.DEFAULT_AVATAR;
        }
      }
      if (typeof cb !== 'undefined') setTimeout(cb, 0);
    } // end ajaxSuccess
  },

  isPageEditDataModified: function() {
    var itemBeforeLeave = JSON.stringify(appModel.data.item);
    var isDataModified = itemBeforeEdit !== itemBeforeLeave;
    if (!isDataModified) window.onbeforeunload = null;
    return isDataModified;
  },
  onEnterPageEdit: function() {
    itemBeforeEdit = JSON.stringify(appModel.data.item);
    window.onbeforeunload = function(e) {
      if (appMain.isPageEditDataModified()) {
        var message = '您已經修改過資料，是否確定要放棄本次的修改？';
        e.returnValue = message;
        return message;
      }
    };
  },
  onLeavePageEdit: function(cb) {
    if (appMain.isPageEditDataModified()) {
      var msgInfo = {
        title: '注意',
        content: '您已經修改過資料，是否確定要放棄本次的修改？',
        btnArray: ['放棄', '取消'],
      };
      var action = function(ButtonPressed) {
        if (ButtonPressed === '放棄') {
          setTimeout(function() {
            return cb();
          }, 500);
        }
      };
      messageApp.confirm(msgInfo, action);
    } else return cb();
  },
  loadItems: function (cb) {
    if(serverSidePaging){
      if (typeof cb !== 'undefined') setTimeout(cb, 0);
      return;
    }

    window.onbeforeunload = null;
    $.get('/api/admin/'+modelName, ajaxSuccess);

    function ajaxSuccess(result) {
      appModel.data.items = result.data.items;
      if (typeof cb !== 'undefined') setTimeout(cb, 0);
    } // end ajaxSuccess
  },
  renderTable: function() {
    <%- include ../default/table.ejs %>
  },
  dblclick: function(index) {
    var id = appModel.data.items[index].id;
    this.show(id);
  },
  show: function (id) {
    location.href = '/admin/#/admin/' + modelName + '/show/' + id;
  },
  edit: function (id) {
    location.href = '/admin/#/admin/' + modelName + '/edit/' + id;
  },
  delete: function() {
    messageApp.confirm({
      title: '刪除',
      content: '確認刪除此筆資料？',
      btnArray: ['刪除', '取消'],
    },
    function(ButtonPressed) {
      if (ButtonPressed ==='刪除') {
        $.ajax({
          url: '/api/admin/' + modelName + '/' + appModel.data.item.id,
          type: 'DELETE',
          dataType: 'json',
          xhrFields: {
            withCredentials: true
          },
          success: ajaxSuccess,
          error: ajaxError,
        });

        function ajaxSuccess(result) {
          appModel.view.table.selectIndex = COMMON.DEFAULT_INDEX;
          messageApp.show({desc: `刪除資料成功！`, type: 'success'});
          setTimeout(function() {
            location.href = '/admin/#/admin/' + modelName;
          }, 500);
        } // end ajaxSuccess

        function ajaxError(result) {
          messageApp.show({desc: '刪除資料失敗！errorMessage: ' + result.responseJSON.message, type: 'error'});
        }
      }
    });
  },
  setupForm: function(type) {

    var registerForm = $("#main-form");
    registerForm.validate({
      rules : formRules,
      messages : formMessages,
      errorPlacement : function(error, element) {
        error.insertAfter(element.parent());
      },
      submitHandler: function(form) {
        if (type == 'create') {
          appMain.save();
          return false;
        } else if(type == 'edit') {
          appMain.update();
          return false;
        }
      }
    });
  }
}

window.appMain = new Vue({
  data: appModel,
  methods: defaultVueMathod,
});
