const COMMON = {
  DOUBLE_CLICK_TIME_PERIOD: 250,
  DEFAULT_INDEX: -1,
  DEFAULT_AVATAR: "img/avatars/default.png",
};

let itemBeforeEdit = {};
let imageAppModel = {
  data: {
    item: {
      displayName: '',
      imagename: '',
      email: '',
      firstName: '',
      lastName: '',
      password: '',
      Roles: [],
      RolesArray: [],
      Passports: [
        {
          password: ""
        }
      ]
    },
    items: [],
    option: {
      passwordConfirm: ''
    }
  },
  view: {
    table: {
      selectIndex: COMMON.DEFAULT_INDEX,
    },
  }
}

let imageApp = new Vue({
  data: imageAppModel,
  methods: {
    setup: function() {
      const restrictedUploader = new qq.FineUploader({
        element: document.getElementById("fine-uploader-validation"),
        template: 'qq-template-validation',
        autoUpload: false,
        request: {
          endpoint: '/upload',
          inputName: 'uploadPic'
        },
        thumbnails: {
          placeholders: {
            waitingPath: '/source/placeholders/waiting-generic.png',
            notAvailablePath: '/source/placeholders/not_available-generic.png'
          }
        },
        validation: {
          allowedExtensions: ['jpeg', 'jpg', 'png'],
          itemLimit: 3,
          sizeLimit: 10240 * 1024 // 50 kB = 50 * 1024 bytes
        },
        callbacks: {
          onError: function(id, name, isError) {
            messageApp.show({desc: isError, type: 'error'});
          },
          onComplete: function(id, name, response) {
            console.log(id, name, response);
          }
        },
        messages: {
          emptyError: '{file} 檔案是空的, 請選擇其他檔案',
          maxHeightImageError: '圖片高度太高',
          maxWidthImageError: '圖片寬度太寬',
          minHeightImageError: '圖片不夠高',
          minWidthImageError: '圖片不夠寬',
          minSizeError: '{file} 檔案過小，最小檔案大小為 {minSizeLimit}',
          noFilesError: '請選擇檔案',
          onLeave: '該檔案正在上傳，如果你離開現在的上傳將被取消。',
          retryFailTooManyItemsError: '重試失敗 - 您已經達到您的檔案限制。',
          sizeError: '{file} 檔案過大，最大檔案大小為 {sizeLimit}.',
          tooManyItemsError: '選擇太多檔案, 檔案限制數量為: {itemLimit}',
          typeError: '{file} 不支援此檔案, 請選擇: {extensions}.',
          unsupportedBrowserIos8Safari: '不可恢復的錯誤 - 這個瀏覽器不允許任何形式的文件上傳，由於iOS8上的Safari嚴重錯誤，請使用iOS8上的Chrome直到蘋果修復了這些問題。',
        }
      });
      qq(document.getElementById("trigger-upload")).attach("click", function() {
        restrictedUploader.uploadStoredFiles();
      });
    },
    cancel: function (event) {

    },
    isPageEditDataModified: function() {
      var itemBeforeLeave = JSON.stringify(imageAppModel.data.item);
      var isDataModified = itemBeforeEdit !== itemBeforeLeave;
      if (!isDataModified) window.onbeforeunload = null;
      return isDataModified;
    },
    onEnterPageEdit: function() {
      itemBeforeEdit = JSON.stringify(imageAppModel.data.item);
      console.log("itemBeforeEdit=>", JSON.parse(itemBeforeEdit));
      window.onbeforeunload = (e) => {
        if (this.isPageEditDataModified()) {
          var message = '您已經修改過資料，是否確定要放棄本次的修改？';
          e.returnValue = message;
          return message;
        }
      };
    },
    onLeavePageEdit: function(cb) {
      if (this.isPageEditDataModified()) {
        var msgInfo = {
          title: '注意',
          content: '您已經修改過資料，是否確定要放棄本次的修改？',
          btnArray: ['放棄', '取消'],
        };
        var action = function(ButtonPressed) {
          if (ButtonPressed === '放棄') {
            setTimeout(() => {
              return cb();
            }, 500);
          }
        };
        messageApp.confirm(msgInfo, action);
      } else return cb();
    },
  },
});
